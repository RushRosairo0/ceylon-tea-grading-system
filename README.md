<div align="center">
  <h1="center" style="font-size: 5em; margin: 0;">LeafMetric - Ceylon Tea Grading System API</h1>
</div>

### LeafMetric – Ceylon Tea Grading System API is a Node.js and Express backend that powers a mobile app for intelligent tea quality assessment. It handles secure user registration and login, manages image uploads and sensory input data, and orchestrates an AI-driven pipeline to analyze tea leaves and provide actionable feedback.

### The API emphasizes security with hashed passwords, JWT-based authentication, and input validation, while remaining modular and scalable through reusable service layers and structured route organization. It delivers reliable, production-ready functionality for the mobile client, enabling consistent tea grading and insightful quality feedback.

### Built with

- [![Node][Node.js]][Node-url]
- [![Express][Express.js]][Express.js-url]
- [![PostgreSQL][PostgreSQL]][PostgreSQL-url]
- [![Sequelize][Sequelize]][Sequelize-url]

## Getting started

### Prerequisites

- NodeJS: [NodeJS download page](https://nodejs.org/en/download)
- PostgreSQL: [PostgreSQL download page](https://www.postgresql.org/download/)
- Postman: [Postman download page](https://www.postman.com/downloads/)

### Installation

1. Clone the repo
   ```bash
   git clone https://github.com/RushRosairo0/ceylon-tea-grading-system-api.git
   ```
2. Step into the project
   ```bash
   cd ceylon-tea-grading-system-api
   ```

### Environment variables setup

1. Create a `.env` file in root folder
   ```
   New-Item -Path . -Name ".env" -ItemType "File"
   ```
2. Open the `.env` file and update the variables

   ```
   ## env variables
   NODE_ENV=development
   HOST=0.0.0.0
   PORT=8000

   ## database configuration
   PG_USER=<postgreSQL user name>
   PG_PASSWORD=<database password>
   PG_DATABASE=<database name>
   PG_HOST=<database host>
   PG_MAXCONN=150

   ## jwt secret
   ACCESS_TOKEN_SECRET=<randomly generated secure string>

   ## prediction pipeline url
   FASTAPI_URL=<prediction API URL>
   ```

### Start the project using terminal

1. Install NPM packages
   ```bash
   npm install
   ```
2. Create database tables using Sequelize
   ```bash
   npm run migrate
   ```

### Other scripts

1. Undo the most recent migration
   ```bash
   npm run migrate:down
   ```
2. Undo all migration
   ```bash
   npm run migrate:down:all
   ```

<!-- ## Assumptions

The following assumptions were made during the development of this project:

### 1. Environment Configuration

- The application runs in a Node.js environment (version 24.13.0).
- Environment variables are provided in a `.env` file.
- The app uses `NODE_ENV=development` and `HOST=0.0.0.0`:`PORT=8000` for development.

### 2. Database

- **PostgreSQL** is used as the primary database for this project, providing a robust, ACID-compliant relational database solution suitable for secure data storage and AI-driven processing.
- The database contains five main tables: **users**, **tea_images**, **predictions**, **user_feedbacks**, and **sensory_evaluations**, with relationships managed through foreign key constraints.
- **users table**
  - Stores user authentication credentials, profile information, and experience level.
  - Each user is uniquely identified by an auto-incremented ID and can have multiple uploaded tea images.
  - Enforces unique email validation and secure password storage.
- **tea_images table**
  - Stores uploaded tea leaf image urls for AI analysis.
  - Each image is associated with a single user and can have one prediction generated by the AI model.
  - Supports URL storage for images and foreign key references to the uploading user.
- **predictions table**
  - Stores AI model outputs including predicted tea grade, predicted category, confidence score, and model version.
  - Each prediction is linked to a single tea image and can optionally have one user feedback entry.
  - Uses ENUM constraints for grade and category to ensure valid predictions.
- **user_feedbacks table**
  - Captures user feedback on AI predictions, including agreement, comments, and associated sensory evaluation.
  - Each feedback is tied to a specific prediction and the user providing the feedback.
  - Supports cascading operations to maintain referential integrity when predictions are deleted.
- **sensory_evaluations table**
  - Stores detailed sensory scores (aroma, taste, aftertaste, color, overall acceptance) submitted by users.
  - Each evaluation belongs to a single user feedback entry.
  - Validates numeric scores to ensure they fall within an acceptable range (1–7).
- **Sequelize** is used as the **ORM** to interact with **PostgreSQL database**:
  - Provides model definitions with proper data types, constraints, and validations.
  - Implements associations between models (e.g., User ↔ TeaImage ↔ Prediction ↔ UserFeedback ↔ SensoryEvaluation) using foreign key relationships.
  - Supports automatic timestamp management and cascading operations for related records.
  - Enables migrations and seeders for consistent database schema management across environments.

### 3. Authentication & Security

- Passwords are hashed securely (e.g., using bcrypt) before being stored in the database.
- User authentication is handled using **JSON Web Tokens (JWT)**, which are issued upon successful login and validated on protected routes.
- Users cannot see other users' details.

### 4. User Roles & Access

- Only authenticated users can access protected endpoints.
- No admin or multi-tier access roles are implemented.

### 5. Request & Response Handling

- Client requests are expected to be well-formed and follow the defined API contract.
- All API requests are validated using **Zod schemas**, ensuring data integrity and preventing invalid inputs.
- A dedicated request-validation middleware is used to automatically check incoming requests before they reach controllers.
- Errors are handled using appropriate HTTP status codes and clear response messages.

### 6. Error Handling

- The application uses a custom error handler to manage errors and send appropriate responses.
- The error handler responds with an appropriate HTTP status code and error message.
- Sensitive error details (like passwords or tokens) are not included in the logs or responses.

### 8. Architecture

- The application follows a layered architecture with the following structure:
  - **client**: The mobile application that interacts with the API.
  - **middleware**: Handles authentication, error handeling, image uploads and request validation using Zod schemas before reaching route handlers.
  - **routes**: Defines the HTTP routes and endpoints exposed to the client.
  - **controllers**: Handles incoming requests and delegates business logic to services.
  - **services**: Contains the core business logic and operations.
  - **repos (ata access layer)**: Provides an abstraction layer for interacting with the database.
  - **database**: PostgreSQL database is used for storing and managing data. -->

## Declaration

- This project, including all source code and documentation, was developed by **H. R. T. Rosairo (UWU/IIT/21/033)** as part of the final year research project, Cylon Tea Grading System Using Multi-Scale Visual Feature Fusion.
- The README file and documentation were reviewed and refined using ChatGPT to ensure proper grammar, clarity, and professional English, as well as best coding practices and a clean, maintainable folder structure.
- Online articles, tutorials, and other reliable sources were consulted to implement the backend functionality, including API design, database interactions, and business logic.
- All core development, design decisions, and thought processes were independently concluded by the author.

## Documentations

## References

1. [Complete Backend Course | Build and Deploy Your First Production-Ready API](https://www.youtube.com/watch?v=rOpEN1JDaD0)
2. [How to Use Node.js for Backend Web Development?](https://www.geeksforgeeks.org/node-js/how-to-use-node-js-for-backend-web-development/)
3. [Folder structure for a Node JS project](https://www.geeksforgeeks.org/node-js/folder-structure-for-a-node-js-project/)
4. [How to Connect PostgreSQL® Database in Node.js](https://scalegrid.io/blog/how-to-connect-postgresql-database-in-node-js/)
5. [How to Use PostgreSQL With Sequelize in Node.js](https://medium.com/@ahsankhaleeq10/how-to-use-postgresql-with-sequelize-in-node-js-1bed818c9f02)
6. [Take Data Validation Seriously by Paul Milham, WildWorks](https://www.youtube.com/watch?v=bfqCQFD9L6k)
7. [Simplified Guide to Setting Up a Global Error Handler in Express.js](https://medium.com/@mohsinansari.dev/simplified-guide-to-setting-up-a-global-error-handler-in-express-js-daf8dd640b69)

<!-- MARKDOWN LINKS & IMAGES -->

[Node.js]: https://img.shields.io/badge/Node.js-12A952?style=for-the-badge&logo=node.js&logoColor=white
[Node-url]: https://nodejs.org/en
[Express.js]: https://img.shields.io/badge/Express.js-000000?style=for-the-badge&logo=express&logoColor=white
[Express.js-url]: https://expressjs.com/
[PostgreSQL]: https://img.shields.io/badge/PostgreSQL-316192?style=for-the-badge&logo=postgresql&logoColor=white
[PostgreSQL-url]: https://www.postgresql.org/
[Sequelize]: https://img.shields.io/badge/Sequelize-52B0E7?style=for-the-badge&logo=Sequelize&logoColor=white
[Sequelize-url]: https://sequelize.org/
